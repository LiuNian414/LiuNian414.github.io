<!DOCTYPE html>
<html>
<head>
    <title>逆水寒帮战BI系统</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* 完整样式表 */
        :root { --primary: #2c3e50; --secondary: #3498db; }
        body { font-family: 'Segoe UI', sans-serif; max-width: 1280px; margin: 0 auto; }
        .container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .input-section { background: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-row { margin: 12px 0; display: grid; grid-template-columns: 100px 1fr; align-items: center; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: var(--secondary); color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .chart-container { height: 500px; border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        /* 新增表格样式 */
        .data-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #battleTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #battleTable th, #battleTable td {
            padding: 12px;
            border: 1px solid #eee;
            text-align: left;
        }
        #battleTable th[contenteditable] {
            background: #f8f9fa;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <h1>逆水寒帮战专业分析系统</h1>
    
    <div class="container">
        <!-- 左侧新增选择框 -->
        <div class="input-section">
            <!-- 新增战斗选择框 -->
            <div class="input-row">
                <label>选择历史战斗：</label>
                <select id="battleSelector" style="width: 100%">
                    <option value="">-- 新建记录 --</option>
                </select>
            </div>

            <!-- 新增日期和对局名称输入 -->
            <div class="input-row">
                <label>战斗日期：</label>
                <input type="date" id="battleDate" required>
            </div>
            <div class="input-row">
                <label>对局名称：</label>
                <input type="text" id="battleName" required>
            </div>

    <!-- 基础信息 -->
    <div class="input-grid">
        <div class="input-row">
            <label>玩家名称：</label>
            <input type="text" id="playerName" required>
        </div>
        <div class="input-row">
            <label>等级：</label>
            <input type="number" id="level" min="1" max="90" required>
        </div>
        <div class="input-row">
            <label>职业：</label>
            <select id="playerClass" onchange="toggleSpecialFields()">
                <option value="素问">素问</option>
                <option value="铁衣">铁衣</option>
                <option value="碎梦">碎梦</option>
                <option value="血河">血河</option>
                <option value="龙吟">龙吟</option>
                <option value="九灵">九灵</option>
                <option value="神相">神相</option>
                <option value="玄机">玄机</option>
                <option value="破铁">破铁</option>
                <option value="天问">天问</option>
                <option value="潮光">潮光</option>
            </select>
        </div>
    </div>

    <!-- 战斗数据 -->
    <div class="input-grid">
        <div class="input-row">
            <label>击败数：</label>
            <input type="number" id="kills" min="0" required>
        </div>
        <div class="input-row">
            <label>助攻数：</label>
            <input type="number" id="assists" min="0" required>
        </div>
        <div class="input-row">
            <label>战备资源：</label>
            <input type="number" id="resources" min="0" required>
        </div>
        <div class="input-row">
            <label>对玩家伤害：</label>
            <input type="number" id="playerDamage" min="0" required>
        </div>
        <div class="input-row">
            <label>对建筑伤害：</label>
            <input type="number" id="buildingDamage" min="0" required>
        </div>
        <div class="input-row">
            <label>治疗值：</label>
            <input type="number" id="heal" min="0">
        </div>
        <div class="input-row">
            <label>承受伤害：</label>
            <input type="number" id="damageTaken" min="0" required>
        </div>
        <div class="input-row">
            <label>重伤次数：</label>
            <input type="number" id="deaths" min="0" required>
        </div>
    </div>

    <!-- 职业特殊字段 -->
    <div class="input-grid special-fields">
        <div class="input-row" data-class="素问">
            <label>化羽次数：</label>
            <input type="number" id="revive" min="0">
        </div>
        <div class="input-row" data-class="潮光">
            <label>清泉次数：</label>
            <input type="number" id="spring" min="0">
        </div>
        <div class="input-row" data-class="九灵">
            <label>焚骨次数：</label>
            <input type="number" id="boneBurn" min="0">
        </div>
        <div class="input-row">
            <label>所在团长：</label>
            <input type="text" id="teamLeader" required>
        </div>
        <div class="input-row">
            <label>职业系数：</label>
            <input type="number" id="classFactor" step="0.01" min="0.5" max="2.0" required>
        </div>
    </div>

    <button onclick="analyze()">提交分析</button>
</div>
<!-- 右侧新增数据表格 -->
        <div class="data-section">
            <table id="battleTable">
                <thead>
                    <tr>
                        <th contenteditable="true">日期</th>
                        <th contenteditable="true">对局名称</th>
                        <th>玩家名称</th>
                        <th>职业</th>
                        <th>综合评分</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据行由JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
    </div>
<script>
// 职业系数默认值映射
const CLASS_FACTORS = {
    '素问': 0.95,
    '铁衣': 1.0,
    '碎梦': 1.2,
    '血河': 0.95,
    '龙吟': 1.0,
    '九灵': 1.0,
    '神相': 1.0,
    '玄机': 1.0,
    '破铁': 1.1,
    '天问': 1.0,
    '潮光': 0.95
};

// 动态显示职业特殊字段
function toggleSpecialFields() {
    const selectedClass = document.getElementById('playerClass').value;
    document.querySelectorAll('.special-fields [data-class]').forEach(field => {
        field.style.display = field.dataset.class === selectedClass ? 'flex' : 'none';
    });
    
    // 自动填充职业系数
    document.getElementById('classFactor').value = CLASS_FACTORS[selectedClass];
}

// 数据收集增强版
function collectInputData() {
    return {
        name: document.getElementById('playerName').value.trim(),
        level: parseInt(document.getElementById('level').value),
        class: document.getElementById('playerClass').value,
        kills: parseInt(document.getElementById('kills').value),
        assists: parseInt(document.getElementById('assists').value),
        resources: parseInt(document.getElementById('resources').value),
        playerDamage: parseInt(document.getElementById('playerDamage').value),
        buildingDamage: parseInt(document.getElementById('buildingDamage').value),
        heal: parseInt(document.getElementById('heal').value) || 0,
        damageTaken: parseInt(document.getElementById('damageTaken').value),
        deaths: parseInt(document.getElementById('deaths').value),
        revive: parseInt(document.getElementById('revive').value) || 0,
        spring: parseInt(document.getElementById('spring').value) || 0,
        boneBurn: parseInt(document.getElementById('boneBurn').value) || 0,
        teamLeader: document.getElementById('teamLeader').value.trim(),
        classFactor: parseFloat(document.getElementById('classFactor').value)
    };
}
    
     
// 新增战斗记录处理函数
function handleBattleRecord(player) {
    // 生成唯一ID
    const recordId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    
    // 创建记录对象
    const record = {
        id: recordId,
        date: player.date,
        battleName: player.battleName,
        playerData: {...player}
    };

    // 添加到数据存储
    battleData.records.push(record);
    
    // 更新UI
    updateBattleSelector();
    updateBattleTable();
}

// 新增选择框更新函数
function updateBattleSelector() {
    const selector = document.getElementById('battleSelector');
    selector.innerHTML = '<option value="">-- 新建记录 --</option>';
    
    battleData.records.forEach(record => {
        const option = document.createElement('option');
        option.value = record.id;
        option.textContent = `${record.date} - ${record.battleName}`;
        selector.appendChild(option);
    });
}

// 新增表格更新函数
function updateBattleTable() {
    const tbody = document.querySelector('#battleTable tbody');
    tbody.innerHTML = '';
    
    battleData.records.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.date}</td>
            <td>${record.battleName}</td>
            <td>${record.playerData.name}</td>
            <td>${record.playerData.class}</td>
            <td>${record.playerData.score.toFixed(2)}</td>
        `;
        tbody.appendChild(row);
    });
}

// 修改后的分析函数
function analyze() {
    try {
        const selectedBattle = document.getElementById('battleSelector').value;
        
        if (selectedBattle) {
            // 分析已有记录
            const record = battleData.records.find(r => r.id === selectedBattle);
            if (record) {
                alert(`已选择战斗记录：${record.battleName}\n当前评分：${record.playerData.score}`);
            }
        } else {
            // 新建记录
            const player = collectInputData();
            const global = calculateGlobalStats();
            
            // 添加日期验证
            if (!player.date) throw new Error('必须选择战斗日期');
            if (!player.battleName) throw new Error('必须填写对局名称');
            
            player.score = classFormulas[player.class](player, global);
            handleBattleRecord(player);
            alert(`新建记录成功！评分：${player.score.toFixed(2)}`);
        }
    } catch (error) {
        console.error('分析失败：', error);
        alert(`分析失败：${error.message}`);
    }
}
// 修改全局数据统计逻辑
function calculateGlobalStats() {
    const stats = { teams: {} };
    
    // 从所有记录中获取玩家数据（关键修复点）
    const allPlayers = battleData.records.map(record => record.playerData);

    // 初始化所有已有团队
    const allTeams = [...new Set(allPlayers.map(p => p.teamLeader))];
    allTeams.forEach(teamName => {
        stats.teams[teamName] = {
            totalDamage: 0,
            totalHeal: 0,
            totalDamageTaken: 0,
            totalDeaths: 0,
            members: [],
            avgDamage: 0,
            avgHeal: 0
        };
    });

    // 统计团队数据（使用allPlayers替代battleData.players）
    allPlayers.forEach(player => {
        const team = stats.teams[player.teamLeader] || {
            totalDamage: 0,
            totalHeal: 0,
            totalDamageTaken: 0,
            totalDeaths: 0,
            members: [],
            avgDamage: 0,
            avgHeal: 0
        };
        
        team.members.push(player);
        team.totalDamage += player.playerDamage + player.buildingDamage;
        team.totalHeal += player.heal || 0;
        team.totalDamageTaken += player.damageTaken || 0;
        team.totalDeaths += player.deaths || 0;
        
        stats.teams[player.teamLeader] = team;
    });

    // 计算平均值（防止除以0）
    Object.values(stats.teams).forEach(team => {
        const dpsMembers = team.members.filter(m => m.class !== '素问');
        const healerMembers = team.members.filter(m => m.class === '素问');
        
        team.avgDamage = dpsMembers.length > 0 
            ? team.totalDamage / dpsMembers.length 
            : 0;
            
        team.avgHeal = healerMembers.length > 0 
            ? team.totalHeal / healerMembers.length 
            : 0;
    });

    return stats;
}

// 修改数据存储结构（确保初始化时包含必要字段）
let battleData = {
    records: [],
    currentSelected: null,
    players: [] // 添加兼容字段防止未定义错误
};
    // 增强版公式实现
const classFormulas = {
    '素问': (player, global) => {
        const team = global.teams[player.teamLeader];
        const avgHeal = team.totalHeal / team.members.filter(m => m.class === '素问').length || 1;
        return Number(((
            ((player.heal + player.damageTaken/1.1 + 
            (player.revive / team.totalDeaths * 2000)) / 
            (avgHeal * 2) * 0.4) +
            (player.heal / 2000 * 0.25) +
            (player.resources / 260 * 0.02) +
            (13 - player.deaths) * 0.01 +
            (player.revive - 15) * 0.01
        ) * player.classFactor).toFixed(2));
    },
    '铁衣': (player, global) => {
        const team = global.teams[player.teamLeader];
        const avgDamage = team.totalDamage / team.members.filter(m => m.class !== '素问').length || 1;
        return Number(((
            (((
                (player.kills + player.assists*0.35 + 
                (player.playerDamage*1.2 + player.buildingDamage*5)/100
                ) / avgDamage * 10
            ) +
            (player.damageTaken / team.totalDamageTaken * 2)
            ) * 0.6) +
            (player.damageTaken / 5000 * 0.35) +
            (player.resources / 260 * 0.03) +
            (10 - player.deaths) * 0.015
        ) * player.classFactor).toFixed(2));
    },
    // 其他职业公式...
};
    </script>

<style>
/* 增强样式 */
.input-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
    margin: 15px 0;
    padding: 10px;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.input-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.special-fields [data-class] {
    display: none;
}

input[type="number"] {
    width: 100px;
}

select {
    width: 150px;
}
</style>

